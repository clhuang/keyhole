// Copyright 2018 Kuei-chun Chen. All rights reserved.

package keyhole

// IndexHTML is a HTML template for D3 charts
var IndexHTML = `
<!DOCTYPE html>
<meta charset="utf-8">

<style>
.mtooltip,html *{font-family:Arial}ul{bottom:0;width:100%;border:1px solid #e7e7e7;background-color:#777;list-style-type:none;margin:0;padding:0;overflow:hidden}li{float:left;border-right:1px solid #bbb}li a{display:block;color:#fff;text-align:center;padding:14px 16px;text-decoration:none}li a:active,li a:hover{background-color:#111;color:#ff0}.mtooltip{position:absolute;background-color:rgba(255,255,255,1);padding:10px;border:1px solid #ddd;font-size:12px;-moz-box-shadow:4px 4px 12px rgba(0,0,0,.5);-webkit-box-shadow:4px 4px 12px rgba(0,0,0,.5);box-shadow:4px 4px 12px rgba(0,0,0,.5);-moz-border-radius:5px;border-radius:5px}.mtooltip h3,.mtooltip p{margin:0;padding:0;text-align:center}.mtooltip span{display:inline-block;margin:2px 0}text{font:12px sans-serif}.legend .series{cursor:pointer}.legend circle{stroke-width:2px}.legend .disabled circle{fill-opacity:0}.axis line,.axis path{fill:none;shape-rendering:crispEdges}.axis path{stroke:#000;stroke-opacity:.75}.axis path.domain{stroke-opacity:.75}.axis line{stroke:#000;stroke-opacity:.25}.axis line.zero{stroke-opacity:.75}.point-paths path{stroke-opacity:0;fill-opacity:0}.lines path{fill:none;stroke-width:3px;stroke-linecap:round}.line.hover path{stroke-width:6px}.lines .point.hover{stroke-width:20px;stroke-opacity:.5}#keyhole{margin:10;padding:10;overflow:none}
</style>

<script src="https://d3js.org/d3.v2.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.12.3/jquery.min.js"></script>
<script>
  var tsvURL = "__API__";

  function mod10(i) {
    return i %% 10
  }
</script>

<body>
  <h3>__TITLE__</h3>

  <ul align='center'>
    <li><a href="/memory">Memory</a></li>
    <li><a href="/page_faults">Page Faults</a></li>
    <li><a href="/connections">Connections</a></li>
    <li><a href="/ops">Ops Counters</a></li>
    <li><a href="/queues">Queues</a></li>
    <li><a href="/latencies">Latencies</a></li>
    <li><a href="/metrics">Metrics</a></li>
    <li><a href="/wiredtiger_cache">WT Cache</a></li>
    <li><a href="/wiredtiger_paging">WT Paging</a></li>
    <li><a href="/wiredtiger_tickets">WT Tickets</a></li>
    <li><a href="/repl_lags">Repl Lags</a></li>
  </ul>

  <div id="keyhole" align='center'>
    <svg></svg>
  </div>
</body>

<script>
function drawLegend(){var t={top:10,right:20,bottom:10,left:50},e=400,n=20,r=d3.scale.category10().range(),o=d3.dispatch("legendClick","legendMouseover","legendMouseout");function i(a){return a.each(function(i){var a=d3.select(this).selectAll("g.legend").data([i]),l=(a.enter().append("g").attr("class","legend").append("g"),a.select("g").attr("transform","translate("+t.left+","+t.top+")")),s=l.selectAll(".series").data(function(t){return t}),c=s.enter().append("g").attr("class","series").on("click",function(t,e){o.legendClick(t,e)}).on("mouseover",function(t,e){o.legendMouseover(t,e)}).on("mouseout",function(t,e){o.legendMouseout(t,e)});c.append("circle").style("fill",function(t,e){return t.color||r[mod10(e)]}).style("stroke",function(t,e){return t.color||r[mod10(e)]}).attr("r",5),c.append("text").text(function(t){return t.label}).attr("text-anchor","start").attr("dy",".32em").attr("dx","8"),s.classed("disabled",function(t){return t.disabled}),s.exit().remove();var d,u=5,p=5,f=0;s.attr("transform",function(n,r){var o=d3.select(this).select("text").node().getComputedTextLength()+28;return d=p,e<t.left+t.right+d+o&&(p=d=5,u+=20),(p+=o)>f&&(f=p),"translate("+d+","+u+")"}),l.attr("transform","translate("+(e-t.right-f)+","+t.top+")"),n=t.top+t.bottom+u+15}),i}return i.dispatch=o,i.margin=function(e){return arguments.length?(t=e,i):t},i.width=function(t){return arguments.length?(e=t,i):e},i.height=function(t){return arguments.length?(n=t,i):n},i.color=function(t){return arguments.length?(r=t,i):r},i}function mD3Line(){var t,e,n={top:0,right:0,bottom:0,left:0},r=960,o=500,i=function(){return 0},a=d3.scale.category10().range(),l=Math.floor(1e4*Math.random()),s=d3.time.scale(),c=d3.scale.linear(),d=d3.dispatch("pointMouseover","pointMouseout");function u(p){return p.each(function(u){var p=u.map(function(t){return t.data});t=t||s,e=e||c,u=u.map(function(t,e){return t.data=t.data.map(function(t){return t.series=e,t}),t}),s.domain(d3.extent(d3.merge(p),function(t){return t[0]})).range([0,r-n.left-n.right]),c.domain(d3.extent(d3.merge(p),function(t){return t[1]})).range([o-n.top-n.bottom,0]);var f=d3.merge(u.map(function(t,e){return t.data.map(function(n,r){t.label,n[0];return[s(n[0]),c(n[1]),e,r]})})),h=d3.select(this).selectAll("g.d3line").data([u]),g=h.enter().append("g").attr("class","d3line").append("g");g.append("g").attr("class","lines"),g.append("g").attr("class","point-clips"),g.append("g").attr("class","point-paths");h.select("g").attr("transform","translate("+n.left+","+n.top+")"),g.append("g").attr("class","voronoi-clip").append("clipPath").attr("id","voronoi-clip-path-"+l).append("rect");h.select(".voronoi-clip rect").attr("x",-10).attr("y",-10).attr("width",r-n.left-n.right+20).attr("height",o-n.top-n.bottom+20),h.select(".point-paths").attr("clip-path","url(#voronoi-clip-path-"+l+")");var m=h.select(".point-clips").selectAll(".clip-path").data(f);m.enter().append("clipPath").attr("class","clip-path").append("circle").attr("r",25),m.exit().remove(),m.attr("id",function(t,e){return"clip-"+l+"-"+t[2]+"-"+t[3]}).attr("transform",function(t){return"translate("+t[0]+","+t[1]+")"});var v=d3.geom.voronoi(f).map(function(t,e){return{data:t,series:f[e][2],point:f[e][3]}}),x=h.select(".point-paths").selectAll("path").data(v);x.enter().append("path").attr("class",function(t,e){return"path-"+e}),x.exit().remove(),x.attr("clip-path",function(t){return"url(#clip-"+l+"-"+t.series+"-"+t.point+")"}).attr("d",function(t){return"M"+t.data.join(",")+"Z"}).on("mouseover",function(t){d.pointMouseover({point:u[t.series].data[t.point],series:u[t.series],pos:[s(u[t.series].data[t.point][0])+n.left,c(u[t.series].data[t.point][1])+n.top],pointIndex:t.point,seriesIndex:t.series})}).on("mouseout",function(t){d.pointMouseout({point:t,series:u[t.series],pointIndex:t.point,seriesIndex:t.series})}),d.on("pointMouseover.point",function(t){h.select(".line-"+t.seriesIndex+" .point-"+t.pointIndex).classed("hover",!0)}),d.on("pointMouseout.point",function(t){h.select(".line-"+t.seriesIndex+" .point-"+t.pointIndex).classed("hover",!1)});var y=h.select(".lines").selectAll(".line").data(function(t){return t},function(t){return t.label});y.enter().append("g").style("stroke-opacity",1e-6).style("fill-opacity",1e-6),d3.transition(y.exit()).style("stroke-opacity",1e-6).style("fill-opacity",1e-6).remove(),y.attr("class",function(t,e){return"line line-"+e}).classed("hover",function(t){return t.hover}).style("fill",function(t,e){return a[mod10(e)]}).style("stroke",function(t,e){return a[mod10(e)]}),d3.transition(y).style("stroke-opacity",1).style("fill-opacity",.5);var b=y.selectAll("path").data(function(t,e){return[t.data]});b.enter().append("path").attr("d",d3.svg.line().x(function(e){return t(e[0])}).y(function(t){return e(t[1])})),b.exit().remove(),d3.transition(b).attr("d",d3.svg.line().x(function(t){return s(t[0])}).y(function(t){return c(t[1])}));var w=y.selectAll("circle.point").data(function(t){return t.data});w.enter().append("circle").attr("cx",function(e){return t(e[0])}).attr("cy",function(t){return e(t[1])}),w.exit().remove(),w.attr("class",function(t,e){return"point point-"+e}),d3.transition(w).attr("cx",function(t){return s(t[0])}).attr("cy",function(t){return c(t[1])}).attr("r",i())}),t=s,e=c,u}return u.dispatch=d,u.margin=function(t){return arguments.length?(n=t,u):n},u.width=function(t){return arguments.length?(r=t,u):r},u.height=function(t){return arguments.length?(o=t,u):o},u.dotRadius=function(t){return arguments.length?(i=d3.functor(t),u):i},u.color=function(t){return arguments.length?(a=t,u):a},u.id=function(t){return arguments.length?(l=t,u):l},u}function mD3Chart(){var t={top:30,right:10,bottom:40,left:60},e=960,n=500,r=function(){return 2.5},o=!1,i=!1,a=d3.scale.category10().range(),l=d3.dispatch("showTooltip","hideTooltip"),s=d3.time.scale(),c=d3.scale.linear(),d=d3.svg.axis().scale(s).orient("bottom"),u=d3.svg.axis().scale(c).orient("left"),p=drawLegend().height(30).color(a),f=mD3Line();function h(r){return r.each(function(g){var m=g.filter(function(t){return!t.disabled}).map(function(t){return t.data});s.domain(d3.extent(d3.merge(m),function(t){return t[0]})).range([0,e-t.left-t.right]),c.domain(d3.extent(d3.merge(m),function(t){return t[1]})).range([n-t.top-t.bottom,0]),f.width(e-t.left-t.right).height(n-t.top-t.bottom).color(g.map(function(t,e){return t.color||a[mod10(e)]}).filter(function(t,e){return!g[e].disabled})),d.ticks(e/100).tickSize(-(n-t.top-t.bottom),0),u.ticks(n/36).tickSize(-(e-t.right-t.left),0);var v=d3.select(this).selectAll("g.wrap").data([g]),x=v.enter().append("g").attr("class","wrap d3lineWithLegend").append("g");x.append("g").attr("class","legendWrap"),x.append("g").attr("class","x axis"),x.append("g").attr("class","y axis"),x.append("g").attr("class","linesWrap"),p.dispatch.on("legendClick",function(t,e){t.disabled=!t.disabled,g.filter(function(t){return!t.disabled}).length||g.forEach(function(t){t.disabled=!1}),r.transition().call(h)}),p.dispatch.on("legendMouseover",function(t,e){t.hover=!0,r.transition().call(h)}),p.dispatch.on("legendMouseout",function(t,e){t.hover=!1,r.transition().call(h)}),f.dispatch.on("pointMouseover.tooltip",function(e){l.showTooltip({point:e.point,series:e.series,pos:[e.pos[0]+t.left,e.pos[1]+t.top],seriesIndex:e.seriesIndex,pointIndex:e.pointIndex})}),f.dispatch.on("pointMouseout.tooltip",function(t){l.hideTooltip(t)}),p.color(a).width(e/2-t.right),v.select(".legendWrap").datum(g).attr("transform","translate("+(e/2-t.left)+","+-p.height()+")").call(p),t.top=p.height();var y=v.select("g").attr("transform","translate("+t.left+","+t.top+")"),b=v.select(".linesWrap").datum(g.filter(function(t){return!t.disabled}));d3.transition(b).call(f);var w=y.select(".x.axis").selectAll("text.axislabel").data([o||null]);w.enter().append("text").attr("class","axislabel").attr("text-anchor","middle").attr("x",s.range()[1]/2).attr("y",t.bottom-20),w.exit().remove(),w.text(function(t){return t}),y.select(".x.axis").attr("transform","translate(0,"+c.range()[0]+")").call(d).selectAll("line.tick").filter(function(t){return!t}).classed("zero",!0);var k=y.select(".y.axis").selectAll("text.axislabel").data([i||null]);k.enter().append("text").attr("class","axislabel").attr("transform","rotate(-90)").attr("text-anchor","middle").attr("y",20-t.left),k.exit().remove(),k.attr("x",-c.range()[0]/2).text(function(t){return t}),y.select(".y.axis").call(u).selectAll("line.tick").filter(function(t){return!t}).classed("zero",!0)}),h}return h.dispatch=l,h.margin=function(e){return arguments.length?(t=e,h):t},h.width=function(t){return arguments.length?(e=t,h):e},h.height=function(t){return arguments.length?(n=t,h):n},h.color=function(t){return arguments.length?(a=t,h):a},h.dotRadius=function(t){return arguments.length?(r=d3.functor(t),f.dotRadius=d3.functor(t),h):r},h.xAxis={},d3.rebind(h.xAxis,d,"tickFormat"),h.xAxis.label=function(t){return arguments.length?(o=t,h):o},h.yAxis={},d3.rebind(h.yAxis,u,"tickFormat"),h.yAxis.label=function(t){return arguments.length?(i=t,h):i},h}!function(t){var e=window.mtooltip={};e.show=function(e,n,r,o){var i=t('<div class="mtooltip">');r=r||"s",o=o||20,i.html(n).css({left:-1e3,top:-1e3,opacity:0}).appendTo("body");var a,l,s=i.height()+parseInt(i.css("padding-top"))+parseInt(i.css("padding-bottom")),c=i.width()+parseInt(i.css("padding-left"))+parseInt(i.css("padding-right")),d=t(window).width(),u=t(window).height(),p=t("body").scrollTop();switch(r){case"e":case"w":case"n":a=e[0]-c/2,l=e[1]+o,a<0&&(a=5),a+c>d&&(a=d-c-5),p+u<l+s&&(l=e[1]-s-o);break;case"s":a=e[0]-c/2,l=e[1]-s-o,a<0&&(a=5),a+c>d&&(a=d-c-5),p>l&&(l=e[1]+o)}i.css({left:a,top:l,opacity:1})},e.cleanup=function(){var e=t(".mtooltip");e.css({"transition-delay":"0 !important","-moz-transition-delay":"0 !important","-webkit-transition-delay":"0 !important"}),e.css("opacity",0),setTimeout(function(){e.remove()},500)}}(jQuery),$(document).ready(function(){var t={top:30,right:10,bottom:50,left:60},e=mD3Chart().xAxis.label("").width(n(t)).height(r(t));function n(t){var e=.9*$(window).width()-20;return e-t.left-t.right-20<0?t.left+t.right+2:e}function r(t){var e=.85*$(window).height()-20;return e-t.top-t.bottom-20<0?t.top+t.bottom+2:e}d3.tsv(tsvURL,function(o){d3.select("#keyhole svg").datum(function(t){for(var e={},n=0;n<t.length;n++){var r=0;for(var o in t[n])0==r?key=new Date(t[n][o]):(null==e[o]&&(e[o]=[]),e[o].push([key,parseFloat(t[n][o])])),r++}var i=[];for(var o in e)i.push({data:e[o],label:o});return i}(o)).transition().duration(500).attr("width",n(t)).attr("height",r(t)).call(e),e.dispatch.on("showTooltip",function(t){var e=$("#keyhole").offset(),n=t.pos[0]+e.left,r=t.pos[1]+e.top,o=d3.format(".04f"),i="<h3>"+t.series.label+'</h3><p><span class="value">['+t.point[0]+", "+o(t.point[1])+"]</span></p>";mtooltip.show([n,r],i)}),e.dispatch.on("hideTooltip",function(t){mtooltip.cleanup()}),$(window).resize(function(){var t=e.margin();e.width(n(t)).height(r(t)),d3.select("#keyhole svg").attr("width",n(t)).attr("height",r(t)).call(e)})})});
</script>
`
